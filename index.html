<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="origin">
    <title>WatchPal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0a0b0f;
            --bg-card: #16181f;
            --bg-input: #21242d;
            --accent: #e50914;
            --accent-hover: #b2070f;
            --success: #46d369; 
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --border-color: #2e323d;
            --shadow-soft: 0 8px 24px rgba(0,0,0,0.5);
            
            /* Brand Colors */
            --netflix-red: #E50914;
            --hulu-green: #1CE783;
            --prime-blue: #00A8E1;
            --disney-blue: #113CCF;
            --max-purple: #4717F6;
            --max-purple: #4717F6;
            --peacock-gold: #eeb400;
            --apple-grey: #333333;
            --peacock-gold: #eeb400;
            --apple-grey: #333333;
        }

        /* ========== INTRO SPLASH SCREEN ========== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0b0f 0%, #1a1c24 50%, #0a0b0f 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow: hidden;
        }

        .splash-screen.fade-out {
            animation: splashFadeOut 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes splashFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; pointer-events: none; }
        }

        .splash-content {
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .splash-logo {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, #fff 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: logoReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards, 
                        gradientShift 3s ease infinite;
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            letter-spacing: -2px;
        }

        @keyframes logoReveal {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .splash-tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
            opacity: 0;
            animation: fadeSlideUp 0.8s ease forwards;
            animation-delay: 0.5s;
            margin-top: 0.5rem;
        }

        .splash-loader {
            width: 120px;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin: 2rem auto 0;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
            animation-delay: 0.7s;
        }

        .splash-loader-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #ff4d5a, var(--accent));
            background-size: 200% 100%;
            border-radius: 4px;
            animation: loadProgress 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards,
                        loaderGlow 1s ease infinite;
            animation-delay: 0.8s;
        }

        @keyframes loadProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes loaderGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Floating cinema particles in splash */
        .splash-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .tmdb-disclaimer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .tmdb-logo {
            height: 11px;
            width: auto;
            vertical-align: middle;
            margin-bottom: 2px;
        }

        .particle {
            position: absolute;
            font-size: 1.5rem;
            opacity: 0;
            animation: particleFloat 4s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { 
                opacity: 0; 
                transform: translateY(100vh) rotate(0deg); 
            }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { 
                opacity: 0; 
                transform: translateY(-100px) rotate(360deg); 
            }
        }

        /* ========== ANIMATED BACKGROUND ========== */
        body {
            background-color: var(--bg-main);
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(229, 9, 20, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(71, 23, 246, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 0%, #1f2330 0%, var(--bg-main) 70%);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Ambient floating orbs */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: orbFloat 15s ease-in-out infinite;
        }

        .orb-1 {
            width: 300px;
            height: 300px;
            background: var(--accent);
            top: -100px;
            left: 10%;
            animation-delay: 0s;
        }

        .orb-2 {
            width: 250px;
            height: 250px;
            background: var(--max-purple);
            bottom: -100px;
            right: 10%;
            animation-delay: -5s;
        }

        .orb-3 {
            width: 200px;
            height: 200px;
            background: var(--disney-blue);
            top: 50%;
            left: -50px;
            animation-delay: -10s;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -30px) scale(1.1); }
            50% { transform: translate(-20px, 20px) scale(0.9); }
            75% { transform: translate(20px, 10px) scale(1.05); }
        }

        /* ========== STAGGERED REVEAL ANIMATIONS ========== */
        .container {
            width: 100%;
            max-width: 800px;
            position: relative;
            z-index: 1;
            opacity: 0;
            transform: translateY(30px);
            animation: contentReveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            animation-delay: 2.3s;
            margin-top: auto;
            margin-bottom: auto;
        }

        @keyframes contentReveal {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeSlideUp {
            0% { opacity: 0; transform: translateY(15px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
            opacity: 0;
            animation: fadeSlideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            animation-delay: 2.4s;
        }

        h1 {
            font-weight: 800;
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(135deg, #fff 0%, var(--text-secondary) 50%, #fff 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            animation: gradientShift 4s ease infinite;
            transition: transform 0.3s ease;
        }

        h1:hover {
            transform: scale(1.02);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 0.5rem;
            opacity: 0;
            animation: fadeSlideUp 0.8s ease forwards;
            animation-delay: 2.6s;
        }

        /* --- Tab Switcher --- */
        .tab-switcher {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            background: #2a2e38;
            transform: translateY(-2px);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: rgba(229, 9, 20, 0.15);
            border-color: var(--accent);
            color: var(--text-primary);
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.2);
        }

        /* --- Controls Card --- */
        .controls-card {
            background: rgba(22, 24, 31, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 
                var(--shadow-soft),
                0 0 0 1px rgba(255,255,255,0.05) inset,
                0 0 60px rgba(229, 9, 20, 0.05);
            border: 1px solid rgba(255,255,255,0.08);
            position: relative;
            z-index: 2;
            opacity: 0;
            transform: translateY(20px);
            animation: cardReveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            animation-delay: 2.5s;
            transition: box-shadow 0.4s ease, transform 0.3s ease;
            will-change: transform, opacity;
        }

        .controls-card:hover {
            box-shadow: 
                0 12px 40px rgba(0,0,0,0.6),
                0 0 0 1px rgba(255,255,255,0.08) inset,
                0 0 80px rgba(229, 9, 20, 0.08);
        }

        @keyframes cardReveal {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* --- Tab Switch Animation Class --- */
        @keyframes switchPop {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        .animating-switch {
            animation: switchPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        /* --- "Show More" Logic (All Screens) --- */
        .advanced-options {
            display: none; 
        }
        
        .advanced-options.show {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            animation: fadeSlideUp 0.4s ease forwards;
        }

        .toggle-advanced-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            padding: 8px;
            margin: -0.5rem auto 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .toggle-advanced-btn:hover {
            color: var(--accent);
        }

        .toggle-advanced-btn svg {
            width: 14px;
            height: 14px;
            transition: transform 0.3s ease;
        }

        .toggle-advanced-btn.active svg {
            transform: rotate(180deg);
        }

        @media (min-width: 700px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            /* When shown on desktop, keep grid layout for advanced options too */
            .advanced-options.show {
                grid-column: span 3;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .toggle-advanced-btn {
                 grid-column: span 3;
            }

            .services-group {
                grid-column: span 3;
            }
            .btn-container {
                 grid-column: span 3;
            }
        }

        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .select-wrapper { position: relative; }
        
        .select-wrapper::after {
            content: '‚ñº';
            font-size: 0.7rem;
            color: var(--accent);
            position: absolute;
            right: 18px; 
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            padding-right: 45px; 
            background: var(--bg-input);
            border: 2px solid transparent;
            color: var(--text-primary);
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 500;
            outline: none;
            appearance: none; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        select:hover { 
            background: #2a2e38; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        select:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.15);
        }

        /* --- Service Toggles --- */
        .services-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .service-toggle {
            flex: 1;
            min-width: 100px;
            position: relative;
        }

        .service-toggle input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .service-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }

        .service-label:hover {
            transform: translateY(-3px) scale(1.02);
            background: #2a2e38;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .service-label:active {
            transform: translateY(-1px) scale(0.98);
        }

        .service-toggle input:checked + .service-label {
            background: #2a2e38;
            color: white;
            border-color: var(--text-secondary);
        }

        .service-toggle input[value="8"]:checked + .service-label { border-color: var(--netflix-red); box-shadow: 0 0 10px rgba(229, 9, 20, 0.2); }
        .service-toggle input[value="15"]:checked + .service-label { border-color: var(--hulu-green); box-shadow: 0 0 10px rgba(28, 231, 131, 0.2); }
        .service-toggle input[value="337"]:checked + .service-label { border-color: var(--disney-blue); box-shadow: 0 0 10px rgba(17, 60, 207, 0.2); }
        .service-toggle input[value="9"]:checked + .service-label { border-color: var(--prime-blue); box-shadow: 0 0 10px rgba(0, 168, 225, 0.2); }
        .service-toggle input[value="1899"]:checked + .service-label { border-color: var(--max-purple); box-shadow: 0 0 10px rgba(71, 23, 246, 0.2); }
        .service-toggle input[value="3353"]:checked + .service-label { border-color: var(--peacock-gold); box-shadow: 0 0 10px rgba(238, 180, 0, 0.2); color: var(--peacock-gold); }
        .service-toggle input[value="350"]:checked + .service-label { border-color: #ffffff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.2); }

        /* --- Button --- */
        button.btn-main {
            width: 100%;
            margin-top: 1rem;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent) 0%, #ff2d3a 50%, var(--accent-hover) 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 20px rgba(229, 9, 20, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            animation: buttonPulse 3s ease-in-out infinite;
        }

        @keyframes buttonPulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Shimmer effect */
        button.btn-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255,255,255,0.2),
                transparent
            );
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        button.btn-main:hover { 
            transform: translateY(-3px) scale(1.02); 
            box-shadow: 0 8px 30px rgba(229, 9, 20, 0.5);
        }
        
        button.btn-main:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        button.btn-main:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            animation: none;
        }
        
        button.btn-main:disabled::before {
            animation: none;
        }

        /* --- Result Card --- */
        #result-area {
            margin-top: 2rem;
            display: none; 
            perspective: 1000px;
            animation: resultReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, max-height 0.4s ease-out, margin-top 0.4s ease-out;
            opacity: 1;
            will-change: transform, opacity, max-height;
            max-height: 2000px; /* Ensure enough height for content */
            overflow: hidden;
        }

        /* FIXED FADE OUT TO PREVENT JUMP */
        #result-area.fade-out {
            opacity: 0 !important;
            transform: translateY(20px) scale(0.98) !important;
            max-height: 0 !important;
            margin-top: 0 !important;
            padding: 0 !important; 
            pointer-events: none;
        }
        
        /* Ensure inner grid borders/shadows don't cause jump */
        #result-area.fade-out .result-grid {
            box-shadow: none !important;
            border: none !important;
        }

        @keyframes resultReveal {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr;
            background: rgba(22, 24, 31, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                0 0 0 1px rgba(255,255,255,0.05) inset;
            border: 1px solid rgba(255,255,255,0.08);
            transform-style: preserve-3d;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.4s ease;
            will-change: transform, opacity;
        }
        
        .result-grid:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 30px 80px rgba(0,0,0,0.6),
                0 0 0 1px rgba(255,255,255,0.08) inset,
                0 0 100px rgba(70, 211, 105, 0.08);
        }
        
        .winner-glow {
            animation: pulseSuccess 1s ease-out forwards;
            border-color: var(--success) !important;
        }
        
        @keyframes pulseSuccess {
            0% { transform: scale(0.98); box-shadow: 0 0 0 rgba(70, 211, 105, 0); }
            50% { transform: scale(1.01); box-shadow: 0 0 50px rgba(70, 211, 105, 0.4); }
            100% { transform: scale(1); box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 30px rgba(70, 211, 105, 0.15); }
        }

        @media (min-width: 650px) {
            .result-grid { grid-template-columns: 300px 1fr; }
        }

        .poster-wrapper {
            background: linear-gradient(135deg, #1a1c24 0%, #0a0b0f 100%);
            position: relative;
            overflow: hidden;
            min-height: 420px;
        }

        /* Poster gradient overlay for depth */
        .poster-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to top, rgba(10, 11, 15, 0.9), transparent);
            pointer-events: none;
            z-index: 1;
        }

        .movie-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rolling .movie-img {
            filter: blur(12px) grayscale(0.9) brightness(0.6);
            transform: scale(1.15);
        }

        .movie-content {
            padding: 1.75rem 2rem 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            gap: 0.25rem;
        }
        
        /* Subtle gradient accent on content side */
        .movie-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent) 0%, var(--success) 50%, var(--max-purple) 100%);
            opacity: 0.6;
        }

        /* --- Provider Badges --- */
        #provider-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 1.25rem;
            min-height: 34px;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .provider-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 8px 14px;
            border-radius: 50px;
            background: #333;
            color: #fff;
            animation: badgeSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
            transform: translateY(10px) scale(0.9);
            border: 1px solid rgba(255,255,255,0.15);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .provider-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        @keyframes badgeSlideIn { 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .provider-netflix { background: linear-gradient(135deg, var(--netflix-red), #b2070f); box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3); }
        .provider-hulu { background: linear-gradient(135deg, var(--hulu-green), #15b366); color: #000; box-shadow: 0 4px 15px rgba(28, 231, 131, 0.3); }
        .provider-disney { background: linear-gradient(135deg, var(--disney-blue), #0a2a8f); box-shadow: 0 4px 15px rgba(17, 60, 207, 0.3); }
        .provider-prime { background: linear-gradient(135deg, var(--prime-blue), #0085b3); box-shadow: 0 4px 15px rgba(0, 168, 225, 0.3); }
        .provider-max { background: linear-gradient(135deg, var(--max-purple), #3310c9); box-shadow: 0 4px 15px rgba(71, 23, 246, 0.3); }
        .provider-peacock { background: linear-gradient(135deg, var(--peacock-gold), #b38600); color: #000; box-shadow: 0 4px 15px rgba(238, 180, 0, 0.3); }
        .provider-apple { background: linear-gradient(135deg, #333333, #111111); box-shadow: 0 4px 15px rgba(255, 255, 255, 0.15); }
        .provider-generic { background: linear-gradient(135deg, #444, #333); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* --- Title & Meta --- */
        .header-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .movie-title {
            font-size: 2.4rem;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleReveal 0.6s ease forwards;
        }
        
        @keyframes titleReveal {
            0% { opacity: 0; transform: translateX(-10px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 1rem;
            width: 100%;
        }

        .btn-watch-now {
            flex: 1;
            min-width: 140px;
            background: linear-gradient(135deg, var(--success) 0%, #1f9d45 100%);
            color: #052e12;
            padding: 14px 20px;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 800;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 20px rgba(70, 211, 105, 0.25);
            border: 1px solid rgba(255,255,255,0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-watch-now::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-watch-now:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(70, 211, 105, 0.4);
            background: linear-gradient(135deg, #5ce67f 0%, var(--success) 100%);
            color: black;
        }
        
        .btn-watch-now:hover::after { opacity: 1; }

        .btn-trailer {
            flex: 1;
            min-width: 140px;
            background: rgba(255, 255, 255, 0.06);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 14px 20px;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: flex; /* Hidden by default via inline style if needed, but controlled by JS */
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-trailer:hover {
            background: white;
            color: black;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(255,255,255,0.15);
            border-color: white;
        }
        
        /* SVG Icon styling */
        .btn-icon {
            width: 18px;
            height: 18px;
            stroke-width: 2.5px;
        }

        .meta-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .rating-badge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 180, 0, 0.1));
            color: #ffd700;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .age-badge {
            padding: 2px 6px;
            border: 1px solid #666;
            color: #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
        }

        .age-red { border-color: #e50914; color: #e50914; }
        .age-yellow { border-color: #ffd700; color: #ffd700; }
        .age-green { border-color: #46d369; color: #46d369; }

        .movie-desc {
            font-size: 0.95rem;
            line-height: 1.7;
            color: rgba(200, 200, 210, 0.9);
            margin: 0;
            letter-spacing: 0.01em;
        }

        .scramble-text {
            color: var(--accent);
            opacity: 0.7;
            font-family: monospace;
        }

        /* --- FOOTER --- */
        .site-footer {
            width: 100%;
            text-align: center;
            padding: 2rem 1rem;
            margin-top: auto;
            color: var(--text-secondary);
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .site-footer a {
            position: relative;
            text-decoration: none;
            font-weight: 600;
            background: linear-gradient(90deg, var(--accent), var(--max-purple));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: text-shadow 0.5s ease-in-out;
        }

        .site-footer a::before {
            content: 'Ryan Kiapour';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--accent);
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        .site-footer a:hover::before {
            opacity: 0;
        }

        .site-footer a:hover {
            text-shadow: 0 0 20px rgba(229, 9, 20, 0.5);
        }

        /* --- TRAILER MODAL --- */
        #trailer-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #trailer-modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            position: relative;
            width: 90%;
            max-width: 900px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.7);
        }

        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
        }


        @media (min-width: 650px) {
            .movie-content::before {
                width: 3px;
                height: 100%;
                background: linear-gradient(180deg, var(--accent) 0%, var(--success) 50%, var(--max-purple) 100%);
            }
        }

    </style>
    <script src="config.js"></script>
</head>
<body>

<div class="splash-screen" id="splash">
    <div class="splash-particles" id="particles"></div>
    <div class="splash-content">
        <div class="splash-logo">WatchPal</div>
        <p class="splash-tagline">Your movie night, decided.</p>
        <div class="splash-loader">
            <div class="splash-loader-bar"></div>
        </div>
    </div>
</div>

<div class="ambient-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<div id="trailer-modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeTrailer()">√ó</button>
        <iframe id="trailer-frame" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
    </div>
</div>

<div class="container">
    <header>
        <h1>WatchPal</h1>
        <p class="subtitle">Deciding what to watch shouldn't take longer than the movie.</p>
    </header>

    <div class="controls-card">
        <div class="tab-switcher">
            <button class="tab-btn active" data-mode="movie" onclick="switchMode('movie')">üé¨ Movies</button>
            <button class="tab-btn" data-mode="tv" onclick="switchMode('tv')">üì∫ TV Shows</button>
        </div>
        <div class="input-grid">
            <div class="input-group">
                <label>Vibe</label>
                <div class="select-wrapper">
                    <select id="genre">
                        <option value="28">‚ö° Adrenaline (Action)</option>
                        <option value="35">üòÇ Laughs (Comedy)</option>
                        <option value="18">üò≠ Drama (In my feels)</option>
                        <option value="878">üß† Mind-bending (Sci-Fi)</option>
                        <option value="27">üò± Terror (Horror)</option>
                        <option value="9648">üïµÔ∏è Mystery (Thriller)</option>
                        <option value="10749">üíï Romance</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>Era</label>
                <div class="select-wrapper">
                    <select id="era">
                        <option value="modern">Modern (2015+)</option>
                        <option value="2000s">The 2000s</option>
                        <option value="90s">The 90s Classic</option>
                        <option value="80s">80s Retro</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>Duration</label>
                <div class="select-wrapper">
                    <select id="duration-option">
                        <option value="any">Any Length</option>
                        <option value="short">Short (Quick Watch)</option>
                        <option value="medium">Standard Length</option>
                        <option value="long">Long (Epic)</option>
                    </select>
                </div>
            </div>

            <div class="advanced-options" id="advanced-options">
                <div class="input-group">
                    <label>Deep Cut?</label>
                    <div class="select-wrapper">
                        <select id="popularity">
                            <option value="hits">Mainstream Hits</option>
                            <option value="gems">Hidden Gems</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label>Animation</label>
                    <div class="select-wrapper">
                        <select id="anime-option">
                            <option value="include">Include</option>
                            <option value="exclude">No Animation</option>
                            <option value="only">Animation Only</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label>For Kids?</label>
                    <div class="select-wrapper">
                        <select id="kids-option">
                            <option value="all">All Ages</option>
                            <option value="kids">Kids & Family</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="toggle-advanced-btn" onclick="toggleAdvanced(this)">
                <span>More Options</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>



            <div class="services-group">
                <label>I have these services:</label>
                <div class="services-container">
                    <div class="service-toggle">
                        <input type="checkbox" id="netflix" value="8">
                        <label for="netflix" class="service-label">Netflix</label>
                    </div>
                    <div class="service-toggle">
                        <input type="checkbox" id="hulu" value="15">
                        <label for="hulu" class="service-label">Hulu</label>
                    </div>
                    <div class="service-toggle">
                        <input type="checkbox" id="disney" value="337">
                        <label for="disney" class="service-label">Disney+</label>
                    </div>
                    <div class="service-toggle">
                        <input type="checkbox" id="max" value="1899">
                        <label for="max" class="service-label">Max</label>
                    </div>
                    <div class="service-toggle">
                        <input type="checkbox" id="prime" value="9">
                        <label for="prime" class="service-label">Prime</label>
                    </div>
                    <div class="service-toggle">
                        <input type="checkbox" id="peacock" value="3353">
                        <label for="peacock" class="service-label">Peacock</label>
                    </div>
                    <div class="service-toggle">
                        <input type="checkbox" id="apple" value="350">
                        <label for="apple" class="service-label">Apple TV+</label>
                    </div>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn-main" onclick="startDecisionEngine()">Pick My Movie</button>
            </div>
        </div>
    </div>

    <div id="result-area">
        <div class="result-grid" id="card-inner">
            <div class="poster-wrapper">
                <img id="poster" class="movie-img" src="" alt="Movie Poster">
            </div>
            <div class="movie-content">
                
                <div id="provider-list"></div>

                <div class="header-row">
                    <h2 id="title" class="movie-title">Title</h2>
                    <div class="action-buttons">
                        <a id="btn-watch-now" class="btn-watch-now" href="#" target="_blank">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                            Watch Now
                        </a>
                        <button id="btn-watch-trailer" class="btn-trailer" onclick="openTrailer()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            Trailer
                        </button>
                    </div>
                </div>

                <div class="meta-row">
                    <span id="age-rating" class="age-badge">NR</span>
                    <span id="year">Year</span>
                    <span class="rating-badge">‚òÖ <span id="rating">0.0</span></span>
                </div>
                <p id="overview" class="movie-desc">Description...</p>
            </div>
        </div>
    </div>
</div>

<footer class="site-footer">
    <p>Developed by <a href="https://ryancodes.xyz" target="_blank" rel="noopener">Ryan Kiapour</a></p>
    <div class="tmdb-disclaimer">
        <span>This website uses <img src="tmdb_logo.png" alt="TMDB Logo" class="tmdb-logo"> and the TMDB APIs for finding movies and TV shows but is not endorsed, certified, or otherwise approved by TMDB.</span>
    </div>
</footer>

<script>
    // ========== SPLASH SCREEN LOGIC ==========
    (function initSplash() {
        const particles = ['üçø', 'üé¨', 'üé•', 'üéûÔ∏è', '‚≠ê', 'üåü', 'üé≠', 'üé¶', 'üìΩÔ∏è', 'üé™', 'üèÜ', 'üé§', 'üí´', '‚ú®', 'üî•', 'üéØ', 'üéÅ', 'üíé', 'üåô', 'üéß'];
        const particlesContainer = document.getElementById('particles');
        
        // Create floating particles - more particles for a livelier splash
        for (let i = 0; i < 24; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.innerText = particles[Math.floor(Math.random() * particles.length)];
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 4 + 's';
            particle.style.animationDuration = (3 + Math.random() * 2) + 's';
            particlesContainer.appendChild(particle);
        }
        
        // Fade out splash after loading completes
        setTimeout(() => {
            const splash = document.getElementById('splash');
            splash.classList.add('fade-out');
            
            // Remove from DOM after animation
            setTimeout(() => {
                splash.style.display = 'none';
            }, 800);
        }, 2300); // Match the CSS animation timing
    })();

    // Initialize API Key from config
    let API_KEY = '';
    if (typeof config !== 'undefined' && config.TMDB_API_KEY) {
        API_KEY = config.TMDB_API_KEY;
    } else {
        console.error("API Key not found! Please create a config.js file with your TMDB_API_KEY.");
        alert("Setup Required: Please add your TMDB API Key to config.js to use this app.");
    }

    const BASE_URL = 'https://api.themoviedb.org/3';

    let candidateMovies = [];
    let animationInterval = null;
    let currentTrailerKey = null;
    let currentMode = 'movie'; // 'movie' or 'tv'

    // Expanded Map for better coverage
    const PROVIDER_MAP = {
        8: { name: 'Netflix', class: 'provider-netflix' },
        15: { name: 'Hulu', class: 'provider-hulu' },
        337: { name: 'Disney+', class: 'provider-disney' },
        9: { name: 'Prime Video', class: 'provider-prime' },
        1899: { name: 'Max', class: 'provider-max' },
        3353: { name: 'Peacock', class: 'provider-peacock' },
        384: { name: 'Peacock', class: 'provider-peacock' }, 
        350: { name: 'Apple TV+', class: 'provider-apple' },
        2: { name: 'Apple TV (Rent)', class: 'provider-generic' },
        3: { name: 'Google Play', class: 'provider-generic' }
    };

    // Map movie genres to TV genres (some are different)
    const TV_GENRE_MAP = {
        '28': '10759',   // Action -> Action & Adventure
        '35': '35',      // Comedy -> Comedy
        '18': '18',      // Drama -> Drama
        '878': '10765',  // Sci-Fi -> Sci-Fi & Fantasy
        '27': '9648',    // Horror -> Mystery (closest TV equivalent)
        '9648': '80',    // Mystery -> Crime
        '10749': '10749' // Romance -> Romance
    };

    function switchMode(mode) {
        currentMode = mode;
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            if (tab.dataset.mode === mode) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });

        // Trigger Animation on inputs to show context switch
        const inputs = document.querySelector('.input-grid');
        inputs.classList.remove('animating-switch');
        void inputs.offsetWidth; // Trigger reflow
        inputs.classList.add('animating-switch');
        
        // Stop any ongoing roulette
        if (animationInterval) {
            clearInterval(animationInterval);
            animationInterval = null;
        }

        // Update button text and reset state immediately
        const btn = document.querySelector('.btn-main');
        btn.innerText = mode === 'movie' ? 'PICK MY MOVIE' : 'PICK MY SHOW';
        btn.disabled = false;
        
        // Fade out any existing results with animation
        const resultArea = document.getElementById('result-area');
        if (resultArea.style.display !== 'none') {
            resultArea.classList.add('fade-out');
            
            // Increased timeout slightly to 500ms to allow CSS transition (0.4s) to fully finish
            // before removing element, preventing the layout jump.
            setTimeout(() => {
                resultArea.style.display = 'none';
                resultArea.classList.remove('fade-out');
                // Clean up card state
                document.getElementById('card-inner').classList.remove('rolling', 'winner-glow');
            }, 500);
        }
    }

    async function startDecisionEngine() {
        const btn = document.querySelector('.btn-main');
        const resultArea = document.getElementById('result-area');
        const cardInner = document.getElementById('card-inner');
        
        btn.disabled = true;
        btn.innerText = "SCANNING DATABASE...";
        cardInner.classList.remove('winner-glow'); 
        document.getElementById('provider-list').innerHTML = '';
        document.getElementById('age-rating').style.display = 'none';
        document.getElementById('btn-watch-trailer').style.display = 'none';
        document.getElementById('btn-watch-now').style.display = 'none';

        resultArea.style.display = 'block';
        cardInner.classList.add('rolling');
        
        if(window.innerWidth < 650) {
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const genre = document.getElementById('genre').value;
        const era = document.getElementById('era').value;
        const popType = document.getElementById('popularity').value;
        
        const animeOpt = document.getElementById('anime-option').value;
        const kidsOpt = document.getElementById('kids-option').value;
        const durationOpt = document.getElementById('duration-option').value;
        
        const userServices = [];
        if(document.getElementById('netflix').checked) userServices.push(8);
        if(document.getElementById('hulu').checked) userServices.push(15);
        if(document.getElementById('disney').checked) userServices.push(337);
        if(document.getElementById('prime').checked) userServices.push(9);
        if(document.getElementById('max').checked) userServices.push(1899);
        if(document.getElementById('peacock').checked) userServices.push(3353);
        if(document.getElementById('apple').checked) userServices.push(350);

        let dateGTE = '2015-01-01';
        let dateLTE = new Date().toISOString().split('T')[0];
        
        if (era === '2000s') { dateGTE = '2000-01-01'; dateLTE = '2014-12-31'; }
        if (era === '90s')   { dateGTE = '1990-01-01'; dateLTE = '1999-12-31'; }
        if (era === '80s')   { dateGTE = '1980-01-01'; dateLTE = '1989-12-31'; }

        let sortBy = 'popularity.desc';
        let minVotes = currentMode === 'movie' ? 300 : 100; // TV shows have fewer votes typically
        if (popType === 'gems') { sortBy = 'vote_average.desc'; minVotes = currentMode === 'movie' ? 150 : 50; }

        // --- NEW URL CONSTRUCTION ---
        let endpoint = currentMode === 'movie' ? 'movie' : 'tv';
        let genreParam = genre;
        
        // Map TV Genres if needed
        if (currentMode === 'tv') {
            genreParam = TV_GENRE_MAP[genre] || genre;
        }

        let withGenres = [genreParam];
        let withoutGenres = [];

        // Anime/Animation Logic
        if (animeOpt === 'exclude') {
            withoutGenres.push('16');
        } else if (animeOpt === 'only') {
            withGenres.push('16');
        }

        // Kids Logic
        if (kidsOpt === 'kids') {
            if (currentMode === 'movie') withGenres.push('10751'); // Family
            else withGenres.push('10762'); // Kids for TV
        }

        const withGenresStr = withGenres.join(',');
        const withoutGenresStr = withoutGenres.join(',');

        let dateFieldGTE = currentMode === 'movie' ? 'primary_release_date.gte' : 'first_air_date.gte';
        let dateFieldLTE = currentMode === 'movie' ? 'primary_release_date.lte' : 'first_air_date.lte';

        let url = `${BASE_URL}/discover/${endpoint}?api_key=${API_KEY}&with_genres=${withGenresStr}`;
        
        if (withoutGenresStr) {
            url += `&without_genres=${withoutGenresStr}`;
        }

        url += `&${dateFieldGTE}=${dateGTE}&${dateFieldLTE}=${dateLTE}&sort_by=${sortBy}&vote_count.gte=${minVotes}&language=en-US&page=1&watch_region=US`;

        // Extra enforcement for Kids
        if (kidsOpt === 'kids') {
            const cert = currentMode === 'movie' ? 'PG' : 'TV-PG';
            url += `&certification_country=US&certification.lte=${cert}`;
        }

        // Duration Logic
        if (durationOpt !== 'any') {
            if (currentMode === 'movie') {
                if (durationOpt === 'short') url += '&with_runtime.lte=95';
                else if (durationOpt === 'medium') url += '&with_runtime.gte=95&with_runtime.lte=135';
                else if (durationOpt === 'long') url += '&with_runtime.gte=135';
            } else {
                // TV Mode (Episode Runtime)
                if (durationOpt === 'short') url += '&with_runtime.lte=35';
                else if (durationOpt === 'medium') url += '&with_runtime.gte=35&with_runtime.lte=65';
                else if (durationOpt === 'long') url += '&with_runtime.gte=65';
            }
        }

        // If user explicitly asks for specific services, filter by them.
        // If not, we search everything and just display where it is later.
        if (userServices.length > 0) {
            const providerString = userServices.join('|'); 
            url += `&with_watch_providers=${providerString}`;
        }

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            candidateMovies = data.results.filter(m => m.poster_path && m.overview);

            if (candidateMovies.length === 0) {
                const typeText = currentMode === 'movie' ? 'movies' : 'TV shows';
                alert(`No ${typeText} found! Try selecting fewer services or different filters.`);
                resetUI();
                return;
            }

            startRoulette(userServices);

        } catch (error) {
            console.error(error);
            alert("Error fetching data. Check API Key.");
            resetUI();
        }
    }

    function startRoulette(userServices) {
        const posterEl = document.getElementById('poster');
        const titleEl = document.getElementById('title');
        
        let steps = 0;
        const maxSteps = 20; 
        const speed = 80;   

        document.getElementById('overview').innerText = "Analyzing streaming libraries...";

        animationInterval = setInterval(() => {
            const randomMov = candidateMovies[Math.floor(Math.random() * candidateMovies.length)];
            posterEl.src = `https://image.tmdb.org/t/p/w342${randomMov.poster_path}`;
            titleEl.innerText = randomMov.title || randomMov.name;
            titleEl.classList.add('scramble-text');

            steps++;
            if (steps >= maxSteps) {
                clearInterval(animationInterval);
                finishRoulette(userServices);
            }
        }, speed);
    }

    async function finishRoulette(userServices) {
        const winner = candidateMovies[Math.floor(Math.random() * candidateMovies.length)];
        const cardInner = document.getElementById('card-inner');
        const titleEl = document.getElementById('title');
        const resultArea = document.getElementById('result-area');
        
        cardInner.classList.remove('rolling');
        titleEl.classList.remove('scramble-text');
        
        // Update Content - handle both movies (title/release_date) and TV shows (name/first_air_date)
        document.getElementById('poster').src = `https://image.tmdb.org/t/p/original${winner.poster_path}`;
        titleEl.innerText = winner.title || winner.name;
        const dateField = winner.release_date || winner.first_air_date || '';
        document.getElementById('year').innerText = dateField ? dateField.split('-')[0] : 'N/A';
        document.getElementById('rating').innerText = winner.vote_average.toFixed(1);
        document.getElementById('overview').innerText = winner.overview;
        
        // Smooth auto-scroll to result card
        setTimeout(() => {
            resultArea.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center'
            });
        }, 100);

        // --- PARALLEL FETCHING: Providers, Age, Videos ---
        const mediaType = currentMode === 'movie' ? 'movie' : 'tv';
        const providerUrl = `${BASE_URL}/${mediaType}/${winner.id}/watch/providers?api_key=${API_KEY}`;
        const releaseUrl = currentMode === 'movie' 
            ? `${BASE_URL}/movie/${winner.id}/release_dates?api_key=${API_KEY}`
            : `${BASE_URL}/tv/${winner.id}/content_ratings?api_key=${API_KEY}`;
        const videoUrl = `${BASE_URL}/${mediaType}/${winner.id}/videos?api_key=${API_KEY}&language=en-US`;

        try {
            const [pRes, rRes, vRes] = await Promise.all([
                fetch(providerUrl), 
                fetch(releaseUrl),
                fetch(videoUrl)
            ]);
            
            const pData = await pRes.json();
            const rData = await rRes.json();
            const vData = await vRes.json();

            // 1. PROVIDERS Logic (The Update)
            const providerListEl = document.getElementById('provider-list');
            providerListEl.innerHTML = '';
            
            if(pData.results && pData.results.US && pData.results.US.flatrate) {
                const availableProviders = pData.results.US.flatrate;
                
                // If user selected nothing, SHOW ALL.
                // If user selected something, show only matches (they filtered for it).
                const showAll = userServices.length === 0;

                availableProviders.forEach(prov => {
                    // We only display if we have a map for it (to keep it clean)
                    // OR if showAll is true we might want to be more generous, 
                    // but for design sake, we stick to the map.
                    if(PROVIDER_MAP[prov.provider_id]) {
                        if(showAll || userServices.includes(prov.provider_id)) {
                             const badge = document.createElement('div');
                             const pInfo = PROVIDER_MAP[prov.provider_id];
                             badge.className = `provider-badge ${pInfo.class}`;
                             badge.innerText = pInfo.name;
                             providerListEl.appendChild(badge);
                        }
                    }
                });
            } else if (pData.results && pData.results.US && pData.results.US.rent) {
                // Fallback: If not on flatrate (Netflix etc), show where to rent
                 const badge = document.createElement('div');
                 badge.className = `provider-badge provider-generic`;
                 badge.innerHTML = `<span>$</span> Available to Rent`;
                 providerListEl.appendChild(badge);
            }

            // 2. AGE RATING
            const ageBadge = document.getElementById('age-rating');
            let certification = 'NR';
            
            if (currentMode === 'movie') {
                // Movie: use release_dates format
                const usRelease = rData.results.find(r => r.iso_3166_1 === 'US');
                if (usRelease && usRelease.release_dates) {
                    const certData = usRelease.release_dates.find(d => d.certification !== '');
                    if (certData) certification = certData.certification;
                }
            } else {
                // TV: use content_ratings format
                const usRating = rData.results.find(r => r.iso_3166_1 === 'US');
                if (usRating && usRating.rating) {
                    certification = usRating.rating;
                }
            }
            
            ageBadge.innerText = certification;
            ageBadge.style.display = 'inline-block';
            ageBadge.className = 'age-badge'; 
            if (['R', 'NC-17', 'TV-MA'].includes(certification)) ageBadge.classList.add('age-red');
            else if (['PG-13', 'TV-14'].includes(certification)) ageBadge.classList.add('age-yellow');
            else if (['G', 'PG', 'TV-G', 'TV-PG', 'TV-Y', 'TV-Y7'].includes(certification)) ageBadge.classList.add('age-green');

            // 3. TRAILER
            const trailerBtn = document.getElementById('btn-watch-trailer');
            const trailer = vData.results.find(v => v.site === 'YouTube' && v.type === 'Trailer') || 
                            vData.results.find(v => v.site === 'YouTube'); // Fallback to any video
            
            if (trailer) {
                currentTrailerKey = trailer.key;
                trailerBtn.style.display = 'flex';
            } else {
                trailerBtn.style.display = 'none';
            }

            // 4. WATCH NOW BUTTON
            const watchBtn = document.getElementById('btn-watch-now');
            if (pData.results && pData.results.US && pData.results.US.link) {
                watchBtn.href = pData.results.US.link;
                watchBtn.style.display = 'flex';
            } else {
                // Determine a search link if no direct provider link
                const query = encodeURIComponent(`${winner.title || winner.name} watch online`);
                watchBtn.href = `https://www.google.com/search?q=${query}`;
                watchBtn.style.display = 'flex';
            }

        } catch(e) { console.log("Fetch error", e); }

        cardInner.classList.add('winner-glow');

        const btn = document.querySelector('.btn-main');
        btn.innerText = "Pick Another";
        btn.disabled = false;
    }

    function resetUI() {
        const btn = document.querySelector('.btn-main');
        btn.innerText = "Pick My Movie";
        btn.disabled = false;
        document.getElementById('result-area').style.display = 'none';
    }

    // --- Modal Logic ---
    function openTrailer() {
        if(!currentTrailerKey) return;
        const modal = document.getElementById('trailer-modal');
        const frame = document.getElementById('trailer-frame');
        // Use youtube-nocookie.com for better embedding compatibility
        frame.src = `https://www.youtube-nocookie.com/embed/${currentTrailerKey}?autoplay=1&rel=0`;
        modal.classList.add('open');
    }

    function closeTrailer() {
        const modal = document.getElementById('trailer-modal');
        const frame = document.getElementById('trailer-frame');
        modal.classList.remove('open');
        // Stop video by resetting src
        frame.src = '';
    }

    // Close on click outside
    document.getElementById('trailer-modal').addEventListener('click', (e) => {
        if (e.target.id === 'trailer-modal') closeTrailer();
    });

    function toggleAdvanced(btn) {
        const advancedDiv = document.getElementById('advanced-options');
        const isHidden = !advancedDiv.classList.contains('show');
        
        if (isHidden) {
            advancedDiv.classList.add('show');
            btn.classList.add('active');
            btn.querySelector('span').innerText = 'Less Options';
        } else {
            advancedDiv.classList.remove('show');
            btn.classList.remove('active');
            btn.querySelector('span').innerText = 'More Options';
        }
    }
</script>

</body>
</html>